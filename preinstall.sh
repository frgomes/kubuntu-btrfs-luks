#!/bin/bash -eux

function make_partitions() {
parted /dev/nvme0n1 <<EOD
mklabel gpt
mkpart primary 1MiB 513MiB
mkpart primary 513MiB 4609MiB
mkpart primary 4609MiB 100%
quit
EOD
}

function make_luks() {
  echo -n "Enter passphrase for encrypted volume: "
  read -s passphrase
  echo ""
  echo -n "${passphrase}" | cryptsetup luksFormat --type=luks1 /dev/nvme0n1p3 -
  echo -n "${passphrase}" | cryptsetup luksOpen /dev/nvme0n1p3 cryptdata -
}

function make_filesystems() {
  mkfs.fat -F32 /dev/nvme0n1p1
  mkfs.btrfs /dev/mapper/cryptdata
}

function change_scripts() {
cat <<EOD | base64 -d | tee > /usr/lib/partman/mount.d/70btrfs
IyEvYmluL3NoCgpzZXQgLS0gJDEKCmZzPSQxCm1wPSQyCnR5cGU9JDMKb3B0aW9ucz0kNApkdW1w
PSQ1CnBhc3M9JDYKCmNhc2UgJHR5cGUgaW4KICAgIGJ0cmZzKQoJb3B0aW9ucz0iJHtvcHRpb25z
JSxzdWJ2b2w9Kn0iCgkjZm9yIHJlbW92aW5nIHRoZSBvcHRpb24gc3Vidm9sLHdoZW4gdGhhdHMg
dGhlIG9ubHkgb3B0aW9uCgkjZWc6IG9wdGlvbnM9PSJzdWJ2b2w9QCIsIG5vIGNvbW1hIHByZXNl
bnQKCW9wdGlvbnM9IiR7b3B0aW9ucyVzdWJ2b2w9Kn0iCgltb3VudCAtdCBidHJmcyAke29wdGlv
bnM6Ky1vICIkb3B0aW9ucyJ9ICRmcyAvdGFyZ2V0JG1wIHx8IGV4aXQgMQoJY2FzZSAkbXAgaW4K
CSAgICAvKQoJCWJ0cmZzIHN1YnZvbHVtZSBjcmVhdGUgL3RhcmdldCRtcC9ACgkJY2htb2QgNzU1
IC90YXJnZXQkbXAvQAoJCXVtb3VudCAvdGFyZ2V0JG1wCgkJb3B0aW9ucz0iJHtvcHRpb25zOisk
b3B0aW9ucyx9c3Vidm9sPUAsc3NkLG5vYXRpbWUsc3BhY2VfY2FjaGUsY29tbWl0PTEyMCxjb21w
cmVzcz16c3RkIgoJCW1vdW50IC10IGJ0cmZzIC1vICRvcHRpb25zICRmcyAvdGFyZ2V0JG1wCgkJ
OzsKCSAgICAvaG9tZSkKCQlidHJmcyBzdWJ2b2x1bWUgY3JlYXRlIC90YXJnZXQkbXAvQGhvbWUK
CQljaG1vZCA3NTUgL3RhcmdldCRtcC9AaG9tZQoJCXVtb3VudCAvdGFyZ2V0JG1wCgkJb3B0aW9u
cz0iJHtvcHRpb25zOiskb3B0aW9ucyx9c3Vidm9sPUBob21lLHNzZCxub2F0aW1lLHNwYWNlX2Nh
Y2hlLGNvbW1pdD0xMjAsY29tcHJlc3M9enN0ZCIKCQltb3VudCAtdCBidHJmcyAtbyAkb3B0aW9u
cyAkZnMgL3RhcmdldCRtcAoJCTs7Cgllc2FjCgllY2hvICJ1bW91bnQgL3RhcmdldCRtcCIKCWV4
aXQgMAoJOzsKZXNhYwoKZXhpdCAxCg==
EOD

cat <<EOD | base64 -d | tee > /usr/lib/partman/fstab.d/btrfs
IyEvYmluL3NoCgouIC9saWIvcGFydG1hbi9saWIvYmFzZS5zaAoKaG9tZV9mb3VuZD0idW5rbm93
biIKCmZvciBkZXYgaW4gJERFVklDRVMvKjsgZG8KCVsgLWQgJGRldiBdIHx8IGNvbnRpbnVlCglj
ZCAkZGV2CglvcGVuX2RpYWxvZyBQQVJUSVRJT05TCgl3aGlsZSB7IHJlYWRfbGluZSBudW0gaWQg
c2l6ZSB0eXBlIGZzIHBhdGggbmFtZTsgWyAiJGlkIiBdOyB9OyBkbwoJCVsgJGZzICE9IGZyZWUg
XSB8fCBjb250aW51ZQoJCVsgLWYgIiRpZC9tZXRob2QiIF0gfHwgY29udGludWUKCQlbIC1mICIk
aWQvYWN0aW5nX2ZpbGVzeXN0ZW0iIF0gfHwgY29udGludWUKCQltZXRob2Q9JChjYXQgJGlkL21l
dGhvZCkKCQlmaWxlc3lzdGVtPSQoY2F0ICRpZC9hY3RpbmdfZmlsZXN5c3RlbSkKCQltb3VudHBv
aW50PSQoY2F0ICRpZC9tb3VudHBvaW50KQoJCWNhc2UgIiRmaWxlc3lzdGVtIiBpbgoJCSAgICBi
dHJmcykKCQkJWyAtZiAiJGlkL21vdW50cG9pbnQiIF0gfHwgY29udGludWUKCQkJIyBkdWUgdG8g
IzI0OTMyMiwgIzI1NTEzNSwgIzI1ODExNzoKCQkJaWYgWyAiJG1vdW50cG9pbnQiID0gL3RtcCBd
OyB0aGVuCgkJCQlybSAtZiAkaWQvb3B0aW9ucy9ub2V4ZWMKCQkJZmkKCQkJb3B0aW9ucz0kKGdl
dF9tb3VudG9wdGlvbnMgJGRldiAkaWQpCgkJCWlmIFsgIiRtb3VudHBvaW50IiA9IC8gXTsgdGhl
bgoJCQkJaWYgWyAiJGhvbWVfZm91bmQiID0gInVua25vd24iIF07IHRoZW4KCQkJCQlob21lX2Zv
dW5kPSJmYWxzZSIKCQkJCWZpCgkJCQlwYXNzPTAKCQkJCWhvbWVfb3B0aW9ucz0iJHtvcHRpb25z
Oiskb3B0aW9ucyx9c3Vidm9sPUBob21lLHNzZCxub2F0aW1lLHNwYWNlX2NhY2hlLGNvbW1pdD0x
MjAsY29tcHJlc3M9enN0ZCIKCQkJCW9wdGlvbnM9IiR7b3B0aW9uczorJG9wdGlvbnMsfXN1YnZv
bD1ALHNzZCxub2F0aW1lLHNwYWNlX2NhY2hlLGNvbW1pdD0xMjAsY29tcHJlc3M9enN0ZCIKCQkJ
CWhvbWVfcGF0aD0iJHBhdGgiCgkJCQlob21lX21wPSIkbW91bnRwb2ludCJob21lCgkJCWVsaWYg
WyAiJG1vdW50cG9pbnQiID0gL2hvbWUgXTsgdGhlbgoJCQkJcGFzcz0wCgkJCQlvcHRpb25zPSIk
e29wdGlvbnM6KyRvcHRpb25zLH1zdWJ2b2w9QGhvbWUsc3NkLG5vYXRpbWUsc3BhY2VfY2FjaGUs
Y29tbWl0PTEyMCxjb21wcmVzcz16c3RkIgoJCQkJaG9tZV9mb3VuZD10cnVlCgkJCWVsc2UKCQkJ
CXBhc3M9MAoJCQlmaQoJCQllY2hvICIkcGF0aCIgIiRtb3VudHBvaW50IiBidHJmcyAkb3B0aW9u
cyAwICRwYXNzCgkJCTs7CgkJICAgICopCgkJCWlmIFsgIiRtb3VudHBvaW50IiA9ICIvaG9tZSIg
XTsgdGhlbgoJCQkJaG9tZV9mb3VuZD0idHJ1ZSIKCQkJZmkKCQkJOzsKCQllc2FjCglkb25lCglj
bG9zZV9kaWFsb2cKZG9uZQoKaWYgWyAiJGhvbWVfZm91bmQiID0gImZhbHNlIiBdOyB0aGVuCgll
Y2hvICIkaG9tZV9wYXRoIiAiJGhvbWVfbXAiIGJ0cmZzICIkaG9tZV9vcHRpb25zIiAwIDAKCWhv
bWVfZm91bmQ9InRydWUiCmZpCQo=
EOD
}

make_partitions
make_luks
# change_scripts
